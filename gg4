stages:
  - install_dependencies
  - frontend
  - backend
  - check_server_status

variables:
  DJANGO_PORT: "8000"
  VUE_PORT: "9980"
  INTERNAL_IP: "10.0.34.181"  # Replace with your specific IP address
  FRONTEND_URL: "http://$INTERNAL_IP:$VUE_PORT"
  BACKEND_URL: "http://$INTERNAL_IP:$DJANGO_PORT"

# Install dependencies for frontend and backend
install_dependencies:
  stage: install_dependencies
  tags:
    - shell
  script:
    # Install frontend dependencies (Inside frontend directory)
    - echo "Installing frontend dependencies..."
    - cd frontend && npm install

    # Install backend dependencies (Inside backend directory)
    - echo "Installing backend dependencies..."
    - cd backend && poetry install

# Start Vue server
frontend:
  stage: frontend
  tags:
    - shell
  script:
    - echo "Starting Vue server on $INTERNAL_IP:$VUE_PORT..."
    - cd frontend && screen -dmS vue bash -c "npm run dev -- --port $VUE_PORT --host $INTERNAL_IP"
    - echo "Vue server started on $INTERNAL_IP:$VUE_PORT"

# Start Django server
backend:
  stage: backend
  tags:
    - shell
  script:
    - echo "Starting Django server on $INTERNAL_IP:$DJANGO_PORT..."
    - cd backend && screen -dmS django bash -c "poetry shell && python manage.py runserver_plus $INTERNAL_IP:$DJANGO_PORT --cert-file devserver.crt --key-file devserver.key"
    - echo "Django server started on $INTERNAL_IP:$DJANGO_PORT"

# Check if the servers are up
check_server_status:
  stage: check_server_status
  tags:
    - shell
  script:
    - echo "Checking if the Vue server is up..."
    - >
      if curl --silent --head --fail "$FRONTEND_URL"; then
        echo "Vue server is up and running on $FRONTEND_URL"
      else
        echo "Vue server is not responding at $FRONTEND_URL"
        exit 1
      fi
    - echo "Checking if the Django server is up..."
    - >
      if curl --silent --head --fail "$BACKEND_URL"; then
        echo "Django server is up and running on $BACKEND_URL"
      else
        echo "Django server is not responding at $BACKEND_URL"
        exit 1
      fi
