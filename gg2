stages:
  - frontend
  - backend

variables:
  DJANGO_PORT: "8000"
  VUE_PORT: "9980"

# Frontend: Vue.js
frontend:
  stage: frontend
  tags:
    - shell
  before_script:
    # Install Node.js and npm (using NodeSource)
    - echo "Installing Node.js and npm..."
    - curl -sL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - node -v  # Verify Node.js version
    - npm -v   # Verify npm version
  script:
    - echo "Setting up Vue.js environment..."

    # Install frontend dependencies
    - echo "Installing frontend dependencies..."
    - npm install

    # Start Vue server in the background
    - echo "Starting Vue server on localhost:$VUE_PORT..."
    - screen -dmS vue bash -c "npm run dev -- --port $VUE_PORT --host localhost"
    - echo "Vue server started on localhost:$VUE_PORT"

    # Optional: Verify if Vue.js app is running (health check)
    - echo "Waiting for Vue.js server to start..."
    - sleep 10  # Wait for Vue to initialize (adjust timing as needed)
    - curl -f http://localhost:$VUE_PORT || (echo "Vue server not running!" && exit 1)

# Backend: Django
backend:
  stage: backend
  tags:
    - shell
  before_script:
    # Ensure Poetry is installed for Python dependencies
    - echo "Installing Poetry..."
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="$HOME/.local/bin:$PATH"  # Ensure Poetry is in PATH
  script:
    - echo "Setting up Django environment..."

    # Install Python dependencies using Poetry
    - echo "Installing backend dependencies..."
    - poetry install

    # Start Django server in the background
    - echo "Starting Django server on localhost:$DJANGO_PORT..."
    - screen -dmS django bash -c "poetry shell && python manage.py runserver_plus localhost:$DJANGO_PORT --cert-file devserver.crt --key-file devserver.key"
    - echo "Django server started on localhost:$DJANGO_PORT"

    # Optional: Verify if Django app is running (health check)
    - echo "Waiting for Django server to start..."
    - sleep 10  # Wait for Django to initialize (adjust timing as needed)
    - curl -f http://localhost:$DJANGO_PORT || (echo "Django server not running!" && exit 1)
