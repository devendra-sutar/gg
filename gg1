#!/bin/bash

GRAFANA_CONFIG="/etc/grafana/grafana.ini"
DYNAMIC_IP=$(hostname -I | awk '{print $1}')
PORT=3000
ROOT_URL="https://$DYNAMIC_IP:$PORT"

# Backup the Grafana configuration file
sudo cp "$GRAFANA_CONFIG" "${GRAFANA_CONFIG}.backup.$(date +%F-%T)"

# Update or add http_addr and root_url inside the [server] section
sudo sed -i "/^\[server\]/,/^\[/{s/^http_addr.*/http_addr = $DYNAMIC_IP/;t;/:/!ahttp_addr = $DYNAMIC_IP}
            /^\[server\]/,/^\[/{s/^root_url.*/root_url = $ROOT_URL/;t;/:/!aroot_url = $ROOT_URL}" "$GRAFANA_CONFIG"

# Restart Grafana service to apply changes
sudo systemctl restart grafana-server.service
