#!/bin/bash

# Exit on any error
set -e

# Variables
ALLOY_VERSION="6.0.1" # Update to the latest version if necessary
ALLOY_JAR="alloy-$ALLOY_VERSION.jar"
ALLOY_URL="https://github.com/AlloyTools/org.alloytools.alloy/releases/download/v$ALLOY_VERSION/$ALLOY_JAR"
INSTALL_DIR="/opt/alloy"
CONFIG_DIR="/etc/alloy"
CONFIG_FILE="$CONFIG_DIR/config.alloy"

# Update and install prerequisites
echo "Updating system and installing prerequisites..."
sudo apt update && sudo apt install -y wget openjdk-17-jdk

# Verify Java installation
echo "Verifying Java installation..."
java -version || { echo "Java installation failed!"; exit 1; }

# Create installation directory
echo "Creating installation directory at $INSTALL_DIR..."
sudo mkdir -p $INSTALL_DIR

# Download Alloy JAR
echo "Downloading Alloy $ALLOY_VERSION..."
sudo wget -O $INSTALL_DIR/$ALLOY_JAR $ALLOY_URL

# Set permissions
echo "Setting permissions for $INSTALL_DIR..."
sudo chmod -R 755 $INSTALL_DIR

# Create configuration directory and file
echo "Setting up configuration file at $CONFIG_FILE..."
sudo mkdir -p $CONFIG_DIR
sudo bash -c "cat > $CONFIG_FILE <<EOL
# Configuration file for Alloy
# This file can be used to store custom settings or references
# Example: Java options, model paths, or solver settings

# Specify maximum heap size for Java
JAVA_OPTS='-Xmx2G'

# Path to additional models (if any)
MODEL_PATH='/opt/alloy/models'

EOL"

sudo chmod 644 $CONFIG_FILE

# Create a wrapper script for Alloy
echo "Creating wrapper script for Alloy..."
WRAPPER_SCRIPT="/usr/local/bin/alloy"
sudo bash -c "cat > $WRAPPER_SCRIPT <<EOL
#!/bin/bash
# Wrapper script for running Alloy with configuration

# Load custom configurations
source $CONFIG_FILE

# Run Alloy with the specified options
java \$JAVA_OPTS -jar $INSTALL_DIR/$ALLOY_JAR "\$@"
EOL"

sudo chmod +x $WRAPPER_SCRIPT

# Verify installation
echo "Verifying Alloy installation..."
alloy --help || { echo "Alloy installation failed!"; exit 1; }

echo "Alloy $ALLOY_VERSION installed successfully with configuration at $CONFIG_FILE!"
