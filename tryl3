#!/bin/bash

# Update and install required packages
sudo apt update -y
sudo apt install gpg wget -y

# Create keyrings directory for Grafana GPG key
sudo mkdir -p /etc/apt/keyrings/

# Download and add the Grafana GPG key
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null

# Add Grafana repository to APT sources list
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list

# Update package lists again and install Alloy
sudo apt-get update -y
sudo apt-get install alloy -y

# Create the Alloy service file
cat << EOF | sudo tee /etc/systemd/system/alloy.service > /dev/null
[Unit]
Description=Alloy Service
After=network.target

[Service]
ExecStart=/usr/bin/alloy
Restart=always
User=root
TimeoutStartSec=60s  # Wait up to 60 seconds for startup


[Install]
WantedBy=multi-user.target
EOF

# Set the correct permissions for the config.alloy file
sudo chmod 644 /etc/alloy/config.alloy || echo "Failed to set permissions on config.alloy"

# Remove any old config file if it exists
sudo rm -f /etc/alloy/config.alloy

# Create the new configuration for Alloy
sudo bash -c 'cat <<EOF > /etc/alloy/config.alloy
prometheus.remote_write "local_prom" { 
    endpoint { 
        url = "http://10.0.34.144:9090/api/v1/write" // define prometheus server endpoint 
    } 
} 

prometheus.exporter.unix "integrations_node_exporter" { 
} 

discovery.relabel "integrations_node_exporter" { 
    targets = prometheus.exporter.unix.integrations_node_exporter.targets 

    rule { 
        target_label = "instance" 
        replacement  = constants.hostname 
    } 

    rule { 
        target_label = "job" 
        replacement = "integrations/cadvisor" 
    } 
} 

prometheus.scrape "integrations_node_exporter" { 
    targets = discovery.relabel.integrations_node_exporter.output 
    forward_to = [prometheus.remote_write.local_prom.receiver] 
} 

prometheus.exporter.cadvisor "example" { 
    docker_host = "unix:///var/run/docker.sock" 
    storage_duration = "5m" 
} 

prometheus.scrape "scraper" { 
    targets    = prometheus.exporter.cadvisor.example.targets 
    forward_to = [prometheus.remote_write.demo.receiver] 
    scrape_interval = "10s" 
} 

prometheus.remote_write "demo" { 
    endpoint { 
        url = "http://prometheus:9090/api/v1/write" 
    } 
} 

// ############################### 
// #### Logging Configuration #### 
// ############################### 

discovery.docker "linux" { 
    host = "unix:///var/run/docker.sock" 
} 

discovery.relabel "logs_integrations_docker" { 
    targets = [] 

    rule { 
        source_labels = ["__meta_docker_container_name"] 
        regex = "/(.*)" 
        target_label = "service_name" 
    } 
} 

loki.source.docker "default" { 
    host       = "unix:///var/run/docker.sock" 
    targets    = discovery.docker.linux.targets 
    labels     = {"platform" = "docker"} 
    relabel_rules = discovery.relabel.logs_integrations_docker.rules 
    forward_to = [loki.write.local.receiver] 
} 

loki.write "local" { 
    endpoint { 
        url = "http://10.0.34.147:3100/loki/api/v1/push" 
    } 
}
EOF'

# Check if the config file exists and set the correct permissions
if [ -f /etc/alloy/config.alloy ]; then
    sudo chmod 644 /etc/alloy/config.alloy
else
    echo "Config file /etc/alloy/config.alloy not found after creation."
fi

# Start the Alloy service
sudo systemctl daemon-reload
sudo systemctl start alloy.service

# Add user to the docker group (optional)
sudo usermod -aG docker alloy

# Restart the Alloy service to apply changes
sudo systemctl restart alloy.service

echo "Alloy setup completed successfully!"
