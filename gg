stages:
  - frontend
  - backend

variables:
  DJANGO_SCREEN_NAME: "django"
  VUE_SCREEN_NAME: "vue"
  DJANGO_PORT: "8000"
  VUE_PORT: "9980"
  DJANGO_LOG: "django_server.log"
  VUE_LOG: "vue_server.log"
  INTERNAL_IP: "10.0.34.181"  # Internal IP for both frontend and backend

frontend:
  stage: frontend
  tags:
    - shell
  script:
    # Verify if the port is available before starting the Vue server
    - echo "Checking if port $VUE_PORT is available..."
    - if lsof -i :$VUE_PORT; then
        echo "Port $VUE_PORT is already in use!";
        exit 1;
      else
        echo "Port $VUE_PORT is available.";
      fi

    # Start Vue server in a screen session, binding to the internal IP
    - echo "Starting Vue server on $INTERNAL_IP:$VUE_PORT..."
    - if screen -list | grep -q "$VUE_SCREEN_NAME"; then
        echo "Screen session '$VUE_SCREEN_NAME' already running.";
      else
        screen -dmS "$VUE_SCREEN_NAME" bash -c "npm run dev -- --port $VUE_PORT --host $INTERNAL_IP > $VUE_LOG 2>&1";
        echo "Vue server started on $INTERNAL_IP:$VUE_PORT.";
      fi

    # Wait for the server to start
    - echo "Waiting for Vue server to fully start..."
    - sleep 15  # Increased wait time to ensure Vue has enough time to start

    # Verify Vue server
    - echo "Checking Vue server on $INTERNAL_IP:$VUE_PORT..."
    - if lsof -i :$VUE_PORT; then
        echo "Vue server is running on $INTERNAL_IP:$VUE_PORT.";
      else
        echo "Vue server is not running on $INTERNAL_IP:$VUE_PORT.";
        exit 1;
      fi

    # Tail Vue logs for debugging
    - echo "Tail Vue logs:"
    - tail -n 40 $VUE_LOG
  artifacts:
    paths:
      - $VUE_LOG
    expire_in: 1 day

backend:
  stage: backend
  tags:
    - shell
  script:
    # Verify if the port is available before starting the Django server
    - echo "Checking if port $DJANGO_PORT is available..."
    - if lsof -i :$DJANGO_PORT; then
        echo "Port $DJANGO_PORT is already in use!";
        exit 1;
      else
        echo "Port $DJANGO_PORT is available.";
      fi

    # Install dependencies for Django
    - echo "Installing Django dependencies..."
    - poetry install

    # Start Django server in a screen session, binding to the internal IP
    - echo "Starting Django server on $INTERNAL_IP:$DJANGO_PORT..."
    - if screen -list | grep -q "$DJANGO_SCREEN_NAME"; then
        echo "Screen session '$DJANGO_SCREEN_NAME' already running.";
      else
        screen -dmS "$DJANGO_SCREEN_NAME" bash -c "poetry shell && python manage.py runserver_plus $INTERNAL_IP:$DJANGO_PORT --cert-file devserver.crt --key-file devserver.key > $DJANGO_LOG 2>&1";
        echo "Django server started on $INTERNAL_IP:$DJANGO_PORT.";
      fi

    # Wait for the server to start
    - echo "Waiting for Django server to fully start..."
    - sleep 15  # Increased wait time to ensure Django has enough time to start

    # Verify Django server
    - echo "Checking Django server on $INTERNAL_IP:$DJANGO_PORT..."
    - if lsof -i :$DJANGO_PORT; then
        echo "Django server is running on $INTERNAL_IP:$DJANGO_PORT.";
      else
        echo "Django server is not running on $INTERNAL_IP:$DJANGO_PORT.";
        exit 1;
      fi

    # Tail Django logs for debugging
    - echo "Tail Django logs:"
    - tail -n 40 $DJANGO_LOG
  artifacts:
    paths:
      - $DJANGO_LOG
    expire_in: 1 day
